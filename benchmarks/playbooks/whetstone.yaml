 - hosts: 127.0.0.1
   connection: local
   tasks:
    - name: making whetstone directory
      file: path={{Dest_dir}}/whetstone state=directory
    - name: making temporary dhrystone directory
      file: path={{Dest_dir}}/whetstone/whetstone_temp state=directory
 
 - hosts:  "{{role}}"

   tasks:

    - name: checking linux distribution
      shell: cat /etc/*-release | grep -c "CentOS"
      register: centos_count
    - name: storing_home
      shell: echo $HOME
      register: home_dir
    - name: cleaning tempT
      shell: rm -rf $HOME/tempT
    - name: cleaning_qtip_result
      shell: rm -rf $HOME/qtip_result
    - name: make directory
      shell: mkdir $HOME/qtip_result
    - include: ./sys_info_pbook.yaml
    - name: Clone unixbench
      shell: git clone https://github.com/kdlucas/byte-unixbench.git $HOME/tempT
    - name: make
      shell: make --directory $HOME/tempT/UnixBench/
    - name: downloading_patch
      shell: cd $HOME/tempT/UnixBench/ && wget https://www.dropbox.com/s/11z85gfu0trkhus/fix-limitation.patch
    - name: applying_patch
      shell: cd $HOME/tempT/UnixBench/ &&  patch Run fix-limitation.patch
    - name: Run Whetstone
      shell: cd $HOME/tempT/UnixBench/&&./Run -v whetstone
    - name: collecting and transforming result script copy
      copy: src=./result_transform/ubench_transform.py dest={{home_dir.stdout}}/qtip_result/
    - name: transforming result
      shell: python $HOME/qtip_result/ubench_transform.py
    - name: copying consolidated report script
      copy: src=./result_transform/final_report.py  dest={{home_dir.stdout}}/qtip_result/
    - name: making consolidated report
      shell: python $HOME/qtip_result/final_report.py Whetstone 
    - name: making directory
      file: path={{home_dir.stdout}}/qtip_result/log state=directory
    - name: copying result to temp directory
      shell: cp -r $HOME/tempT/UnixBench/results/* $HOME/qtip_result/log/
    - name: registering files
      shell: (cd $HOME/qtip_result/; find . -maxdepth 1 -name "*.json") | cut -d'/' -f2
      register: files_to_copy
    - name: copy results
      fetch:  src={{home_dir.stdout}}/qtip_result/{{item}} dest={{Dest_dir}}/whetstone/whetstone_temp
      with_items: files_to_copy.stdout_lines 
    - name: registering log files
      shell: (cd $HOME/qtip_result/log/; find . -maxdepth 1 -name "*.log") | cut -d'/' -f2
      register: copy_log_results
    - name: copying log results
      fetch:  src={{home_dir.stdout}}/qtip_result/log/{{item}} dest={{Dest_dir}}/whetstone/whetstone_temp
      with_items: copy_log_results.stdout_lines
    - name: cleaning tempT
      shell: rm -rf $HOME/tempT
    - name: cleaning_qtip_result
      shell: rm -rf $HOME/qtip_result


 - hosts: 127.0.0.1
   connection: local
   tasks:
    - name: extracting_json
      shell: ( find  {{Dest_dir}}/whetstone/whetstone_temp/ -name "*.json" | xargs cp -t {{Dest_dir}}/whetstone/)
    - name: making_logs_folder
      shell: mkdir -p {{Dest_dir}}/whetstone/logs
    - name: extracting_log
      shell: ( find {{Dest_dir}}/whetstone/whetstone_temp/ -name "*.log"  | xargs cp -t {{Dest_dir}}/whetstone/logs)
    - name: removing whetstone_temp 
      shell: rm -rf {{Dest_dir}}/whetstone/whetstone_temp
