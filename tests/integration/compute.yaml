##############################################################################
# Copyright (c) 2017 ZTE Corporation and others.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

---
# Prepare connection to SUT (System Under Test)
- hosts: fuel-master
  gather_facts: no
  tasks:
  - name: collect facts of fuel hosts
    fuel:
  - name: add compute node to ansible inventory
    add_host:
      name: "{{ hosts_meta[item]['ip'] }}"
      groups: compute
      ansible_user: root
      ansible_ssh_common_args: '-o StrictHostKeyChecking=No -o ProxyJump=fuel-master'
    with_items: "{{ hosts.compute }}"

# Execute compute benchmark plan and collect data
# - system information
# - test condition
# - performance metrics
- hosts: compute
  tasks:
  - name: check ssh connection
    ping:
  # collect system information
  - name: collect system information
    include: tasks/inxi.yaml

# TODO(yujunz) Calculate QPI from composed metrics
# e.g.
# qpi:
#   score: 2048
#   spec: compute
#   metrics: # values, not spec
#     - ref_metric_a
#     - ref_metric_b

# Generate and publish report
- hosts: local
  tasks:
  - name: create system information report
    template: src=templates/inxi-system-info.j2 dest=reports/inxi-system-info
  # TODO(yujunz) push test result to testapi
