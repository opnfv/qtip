##############################################################################
# Copyright (c) 2017 ZTE Corporation and others.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

---
# Execute compute benchmark plan and collect data
# - system information
# - test condition
# - performance metrics

- hosts: compute

  pre_tasks:
  - name: check ssh connection
    ping:

  roles:
  - development-tools

  post_tasks:
  - name: create dumping directories
    file:
      path: "{{ qtip_dump }}/{{ inventory_hostname }}"
      state: directory
    delegate_to: localhost

  tags: [setup]


- hosts: compute

  roles:

    - { role: unixbench, tags: [unixbench] }

  tasks:

  - name: collect system information
    include: "{{ qtip_resources }}/metric/inxi.yaml"

  - name: ssl metrics
    include: "{{ qtip_resources }}/metric/openssl.yaml"
    tags: [ssl]

  - name: DPI metrics
    include: "{{ qtip_resources }}/metric/nDPI.yaml"
    vars:
      nDPI_cwd: "{{ ansible_env.HOME }}/qtip/nDPI"
      nDPI_file: "dpi.pcap"
    tags: [dpi]

  - name: memory metrics
    include: "{{ qtip_resources }}/metric/ramspeed.yaml"
    vars:
      cwd: "{{ ansible_env.HOME }}/qtip/ramspeed"
    tags: [mem]

  - name: calculate QPI of compute
    calculate:
      metrics:
        ssl_rsa: "{{ openssl_rsa_metrics }}"
      spec:   "{{ qtip_resources }}/QPI/compute.yaml"
    register: qpi_result
    delegate_to: localhost
    tags: [calculate]


- hosts: localhost

  tasks:

  - name: aggregate QPI results from all tested nodes
    aggregate:
      group: compute
    register: pod_result

  # Generate and publish report

  - name: create report folder
    file:
      path: "{{ qtip_reports }}"
      state: directory

  - name: create system information report
    template:
      src: "{{ qtip_resources }}/template/system-info.j2"
      dest: "{{ qtip_reports }}/system-info"

  - name: create qpi report
    template:
      src: "{{ qtip_resources }}/template/qpi-report.j2"
      dest: "{{ qtip_reports }}/qpi-report"
    tags: [report]

  - name: create dpi metrics report
    template:
      src: "{{ qtip_resources }}/template/dpi-metrics.j2"
      dest: "{{ qtip_reports }}/dpi-metrics"
    tags: [report, dpi]

  - name: push result to testapi
    uri:
      url: "{{ testapi_url }}/results"
      body: "{{ item|to_json }}"
      method: POST
      body_format: json
      status_code: 200
    with_items:
      -
        project_name: "{{ project_name }}"
        case_name: "{{ case_name }}"
        pod_name: "{{ pod_name }}"
        installer: "{{ installer }}"
        version: "{{ version }}"
        scenario: "{{ scenario }}"
        start_date: "{{ ansible_date_time.date }}"
        stop_date: "{{ ansible_date_time.date }}"
        criteria: ""
        details: "{{ pod_result }}"

    tags: [testapi]
