##############################################################################
# Copyright (c) 2017 ZTE Corporation and others.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

---
# Execute compute benchmark plan and collect data
# - system information
# - test condition
# - performance metrics
- hosts: compute
  tasks:
  - name: check ssh connection
    ping:
  - name: collect system information
    include: "{{ qtip_resources }}/metric/inxi.yaml"
  - name: ssl metrics
    include: "{{ qtip_resources }}/metric/openssl.yaml"
    tags: [ssl]

- hosts: compute
  tasks:
  - name: calculate QPI of compute
    calculate:
      metrics:
        ssl_rsa: "{{ openssl_rsa_metrics }}"
      spec:   "{{ qtip_resources }}/QPI/compute.yaml"
    register: qpi_result
    delegate_to: localhost
    tags: [calculate]

# Generate and publish report
- hosts: local
  tasks:
  - name: create report folder
    file:
      path: "{{ qtip_reports }}"
      state: directory
  - name: create system information report
    template:
      src: "{{ qtip_resources }}/template/system-info.j2"
      dest: "{{ qtip_reports }}/system-info"
  - name: create qpi report
    template:
      src: "{{ qtip_resources }}/template/qpi-report.j2"
      dest: "{{ qtip_reports }}/qpi-report"
    tags: [report]
  - name: push result to testapi
    uri:
      url: "{{ testapi_url }}/results"
      body: "{{ item|to_json}}"
      method: POST
      body_format: json
      status_code: 200
    with_items:
      -
        project_name: qtip
        case_name: compute
        pod_name: internal
        installer: fuel
        version: master
        scenario: demo
        start_date: "{{ ansible_date_time.date }}"
        stop_date: "{{ ansible_date_time.date }}"
        criteria: "2048"
        details: ""

    tags: [testapi]
