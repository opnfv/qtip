##############################################################################
# Copyright (c) 2017 ZTE Corporation and others.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

---
# Prepare connection to SUT (System Under Test)
- hosts: fuel-master
  gather_facts: no
  tasks:
  - name: collect facts of fuel hosts
    fuel:
  - name: add compute node to ansible inventory
    add_host:
      name: "{{ hosts_meta[item]['ip'] }}"
      groups: compute
      ansible_user: root
      ansible_ssh_common_args: '-o StrictHostKeyChecking=No -o ProxyJump=fuel-master'
    with_items: "{{ hosts.compute }}"

# Execute compute benchmark plan and collect data
# - system information
# - test condition
# - performance metrics
- hosts: compute
  tasks:
  - name: check ssh connection
    ping:
  # collect system information
  - name: collect system information
    include: tasks/inxi.yaml
  - name: ssl metrics
    include: tasks/openssl.yaml

# TODO(yujunz) Calculate QPI from composed metrics
# e.g.
# qpi:
#   score: 2048
#   spec: compute
#   metrics: # values, not spec
#     - ref_metric_a
#     - ref_metric_b

- hosts: compute
  tasks:
  - name: calculate QPI of compute
    calculate:
      metrics:
        ssl_rsa: "{{ openssl_rsa_metrics }}"
      spec:   # TODO(yujunz) load spec from file
        qpi: compute
        description: QTIP Performance Index of compute
        formula: weighted arithmetic mean
        sections: # split based on different application
        - name: SSL
          description: cryptography and SSL/TLS performance
          formula: geometric mean
          metrics:
            -
              name: ssl_rsa
              formula: geometric mean
              workloads:
                rsa_sign_512: # full definition of a workload
                  name: RSA-512
                  description: RSA signature 512 bits
                  baseline: 14982.3
                rsa_verify_512: 180619.2  # short definition of a workload
                rsa_sign_1024: 5037.7
                rsa_verify_1024: 67359.9
                rsa_sign_2048: 713.6
                rsa_verify_2048: 23458.0
                rsa_sign_4096: 102.1
                rsa_verify_4096: 6402.9
    register: compute_qpi
    delegate_to: localhost
  - debug: var=compute_qpi

# Generate and publish report
- hosts: local
  tasks:
  - name: create system information report
    local_action: template src=templates/inxi-system-info.j2 dest=reports/inxi-system-info
    delegate_to: localhost
  # TODO(yujunz) push test result to testapi
